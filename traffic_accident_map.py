import streamlit as st
import pandas as pd
import folium
from streamlit_folium import st_folium
# é€™è£¡åŸæœ¬æƒ³ç”¨ google map apiï¼Œä½†è¦éŒ¢å°±ç®—äº†ï¼Œæ”¹ç”¨å…è²»çš„ geopy
from geopy.geocoders import Nominatim
from geopy.exc import GeocoderTimedOut
import math
import requests
import polyline
import os
# é€™å…©å€‹æ˜¯ç”¨ä¾†åšåœ°åœ–åœ–ä¾‹çš„ï¼Œç¶²è·¯ä¸Šæ‰¾çš„ç¯„ä¾‹
from branca.element import Template, MacroElement

# è€å¸«èªªéè¦è™•ç†ä¾‹å¤–ç‹€æ³ï¼Œæ‰€ä»¥å…ˆæª¢æŸ¥æœ‰æ²’æœ‰è£ shapely é€™å€‹å¥—ä»¶
# å¦‚æœæ²’è£å°±ä¸èƒ½ç”¨é€²éšçš„å¹¾ä½•é‹ç®—ï¼Œåªèƒ½ç”¨ç°¡å–®çš„ç®—æ³•
try:
    from shapely.geometry import LineString, Point
    SHAPELY_AVAILABLE = True
except ImportError:
    # æ²’è£å°±ç®—äº†ï¼Œè¨­å€‹ flag è¨˜èµ·ä¾†
    SHAPELY_AVAILABLE = False

# æŠŠè³‡æ–™è®€å–åŠŸèƒ½ç¨ç«‹å‡ºä¾†ï¼Œé‚„æœ‰åŠ ä¸Š cache é€™æ¨£æ‰ä¸æœƒæ¯æ¬¡æŒ‰æŒ‰éˆ•éƒ½è¦é‡è·‘ä¸€æ¬¡
@st.cache_data
def load_taichung_open_data():
    """
    é€™é‚Šæ˜¯è™•ç†è³‡æ–™è®€å–çš„åœ°æ–¹ã€‚
    åŸæœ¬æ‰“ç®—ç›´æ¥è®€ CSVï¼Œä½†ç™¼ç¾å…¬é–‹è³‡æ–™æ ¼å¼æœ‰é»äº‚ï¼Œè€Œä¸”æœ‰äº›æœˆä»½ç¼ºç¶“ç·¯åº¦ã€‚
    æ‰€ä»¥å¾Œä¾†æ±ºå®šæŠŠæ•´ç†å¥½çš„è³‡æ–™ç›´æ¥å¯«åœ¨ code è£¡é¢ç•¶ä½œ fallbackï¼Œæ¯”è¼ƒç©©ã€‚
    """
    
    # é€™æ˜¯åŸæœ¬ CSV çš„è·¯å¾‘ï¼Œä½†æˆ‘å¾Œä¾†éƒ½ç”¨ä¸‹é¢çš„ list äº†ï¼Œé€™å€‹ç•¶ä½œåƒè€ƒ
    csv_path = "traffic_accidents.csv" 
    
    # æŠŠä¹‹å‰è¾›è‹¦æ•´ç†å¥½çš„ 113-114 å¹´ç†±é–€è·¯å£è³‡æ–™å…¨éƒ¨è²¼éä¾†
    # åŒ…å«ç¶“ç·¯åº¦ã€äº‹æ•…ä»¶æ•¸ã€é¢¨éšªç­‰ç´šç­‰ç­‰
    # é›–ç„¶æœ‰é»é•·ï¼Œä½†é€™æ¨£æœ€ä¿éšªï¼Œä¸æœƒå› ç‚ºå°‘æª”æ¡ˆå°±æ›æ‰
    fallback_data = [
        {'lat': 24.163026, 'lon': 120.645084, 'count': 20, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:20), (è¥¿å±¯å€)æ–‡å¿ƒè·¯èˆ‡è‡ºç£å¤§é“å£'},
        {'lat': 24.152033, 'lon': 120.683056, 'count': 12, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:12), (åŒ—å€)ä¸‰æ°‘è·¯èˆ‡å´‡å¾·è·¯å£'},
        {'lat': 24.128038, 'lon': 120.661025, 'count': 11, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:11), (å—å€)æ–‡å¿ƒå—è·¯èˆ‡å»ºåœ‹åŒ—è·¯å£'},
        {'lat': 24.148055, 'lon': 120.674011, 'count': 15, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:15), (è¥¿å±¯å€)è‡ºç£å¤§é“èˆ‡æƒ ä¸­è·¯å£'},
        {'lat': 24.142011, 'lon': 120.638055, 'count': 17, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:17), (å—å±¯å€)äº”æ¬Šè¥¿è·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.168022, 'lon': 120.635088, 'count': 10, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:10), (è¥¿å±¯å€)å®‰å’Œè·¯èˆ‡è‡ºç£å¤§é“å£'},
        {'lat': 24.136845, 'lon': 120.685022, 'count': 10, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:10), (æ±å€)æŒ¯èˆˆè·¯èˆ‡ç’°ä¸­æ±è·¯å£'},
        {'lat': 24.195022, 'lon': 120.675011, 'count': 13, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:13), (åŒ—å±¯å€)ç’°ä¸­è·¯èˆ‡å´‡å¾·è·¯å£'},
        {'lat': 24.111234, 'lon': 120.655432, 'count': 11, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:11), (å—å€)å¿ æ˜å—è·¯èˆ‡åœ‹å…‰è·¯å£'},
        {'lat': 24.105022, 'lon': 120.690011, 'count': 10, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:10), (å¤§é‡Œå€)å¾·èŠ³å—è·¯èˆ‡ç’°ä¸­æ±è·¯å£'},
        {'lat': 24.178822, 'lon': 120.646544, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (è¥¿å±¯å€)ç¦ç§‘è·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.155018, 'lon': 120.663088, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (è¥¿å€)è‡ºç£å¤§é“èˆ‡æ°‘æ¬Šè·¯å£'},
        {'lat': 24.120055, 'lon': 120.660088, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (å—å€)å¾©èˆˆè·¯èˆ‡å—å¹³è·¯å£'},
        {'lat': 24.185033, 'lon': 120.605044, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (æ²™é¹¿å€)è‡ºç£å¤§é“èˆ‡æ­£è‹±è·¯å£'},
        {'lat': 24.205011, 'lon': 120.705044, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (åŒ—å±¯å€)æ¾ç«¹è·¯èˆ‡æ—±æºªæ±è·¯å£'},
        {'lat': 24.169443, 'lon': 120.627778, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (è¥¿å±¯å€)ç’°ä¸­è·¯èˆ‡å¸‚æ”¿è·¯å£'},
        {'lat': 24.183333, 'lon': 120.700000, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (åŒ—å±¯å€)æ¾ç«¹è·¯èˆ‡ç’°ä¸­æ±è·¯å£'},
        {'lat': 24.116667, 'lon': 120.666667, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (å—å€)ç¾æ‘å—è·¯èˆ‡å¿ æ˜å—è·¯å£'},
        {'lat': 24.233333, 'lon': 120.566667, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (æ²™é¹¿å€)ä¸‰æ°‘è·¯èˆ‡è‡ºç£å¤§é“å£'},
        {'lat': 24.133333, 'lon': 120.633333, 'count': 13, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:13), (å—å±¯å€)ç’°ä¸­è·¯èˆ‡å‘ä¸Šè·¯å£'},
        {'lat': 24.175000, 'lon': 120.625000, 'count': 13, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:13), (è¥¿å±¯å€)è¥¿å±¯è·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.141667, 'lon': 120.641667, 'count': 12, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:12), (å—å±¯å€)å‘ä¸Šè·¯èˆ‡äº”æ¬Šè¥¿è·¯å£'},
        {'lat': 24.191667, 'lon': 120.675000, 'count': 10, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:10), (åŒ—å±¯å€)å´‡å¾·è·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.133333, 'lon': 120.616667, 'count': 10, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:10), (å—å±¯å€)å‘ä¸Šè·¯èˆ‡å¿ å‹‡è·¯å£'},
        {'lat': 24.125000, 'lon': 120.658333, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (å—å€)å¿ æ˜å—è·¯èˆ‡å—å±¯è·¯å£'},
        {'lat': 24.141667, 'lon': 120.633333, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (å—å±¯å€)äº”æ¬Šè¥¿è·¯èˆ‡å‘ä¸Šè·¯å£'},
        {'lat': 24.116667, 'lon': 120.666667, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (å—å€)ç¾æ‘å—è·¯èˆ‡é«˜å·¥è·¯å£'},
        {'lat': 24.175000, 'lon': 120.633333, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (è¥¿å±¯å€)è‡ºç£å¤§é“èˆ‡æ²³å—è·¯å£'},
        {'lat': 24.166667, 'lon': 120.633333, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (è¥¿å±¯å€)æœå¯Œè·¯èˆ‡è‡ºç£å¤§é“å£'},
        {'lat': 24.183333, 'lon': 120.583333, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)è‡ºç£å¤§é“èˆ‡åœ‹éš›è¡—å£'},
        {'lat': 24.183333, 'lon': 120.600000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)æ±å¤§è·¯èˆ‡è‡ºç£å¤§é“å£'},
        {'lat': 24.191667, 'lon': 120.683333, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (åŒ—å±¯å€)å´‡å¾·åè·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.150000, 'lon': 120.683333, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (åŒ—å€)å¤ªåŸè·¯èˆ‡å´‡å¾·è·¯å£'},
        {'lat': 24.166667, 'lon': 120.700000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (åŒ—å±¯å€)ç’°ä¸­æ±è·¯èˆ‡å¤ªåŸè·¯å£'},
        {'lat': 24.108333, 'lon': 120.608333, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (çƒæ—¥å€)ç«™å€ä¸€è·¯èˆ‡é«˜éµäº”è·¯å£'},
        {'lat': 24.158333, 'lon': 120.683333, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (åŒ—å€)æ¼¢é™½è¡—èˆ‡æ­¦æ¼¢è¡—å£'},
        {'lat': 24.166667, 'lon': 120.675000, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (åŒ—å€)æ¢…å·æ±è·¯èˆ‡å¤ªåŸè·¯å£'},
        {'lat': 24.150000, 'lon': 120.716667, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (å¤ªå¹³å€)ç’°ä¸­æ±è·¯èˆ‡ä¸­å±±è·¯å£'},
        {'lat': 24.150000, 'lon': 120.666667, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (è¥¿å€)äº”æ¬Šè·¯èˆ‡è‡ºç£å¤§é“å£'},
        {'lat': 24.175000, 'lon': 120.633333, 'count': 11, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:11), (è¥¿å±¯å€)æ²³å—è·¯èˆ‡è‡ºç£å¤§é“å£'},
        {'lat': 24.183333, 'lon': 120.650000, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (è¥¿å±¯å€)ä¸­æ¸…è·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.166667, 'lon': 120.700000, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (åŒ—å±¯å€)å¤ªåŸè·¯èˆ‡ç’°ä¸­æ±è·¯å£'},
        {'lat': 24.175000, 'lon': 120.683333, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (åŒ—å±¯å€)æ˜Œå¹³è·¯èˆ‡åŒ—å±¯è·¯å£'},
        {'lat': 24.191667, 'lon': 120.633333, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)ä¸­ç§‘è·¯èˆ‡å»£ç¦è·¯å£'},
        {'lat': 24.158333, 'lon': 120.683333, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (åŒ—å€)å¥è¡Œè·¯èˆ‡å­¸å£«è·¯å£'},
        {'lat': 24.175000, 'lon': 120.683333, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (åŒ—å±¯å€)å´‡å¾·è·¯èˆ‡æ–‡å¿ƒè·¯å£'},
        {'lat': 24.133333, 'lon': 120.716667, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (å¤ªå¹³å€)å¸‚æ°‘å¤§é“èˆ‡ç’°ä¸­æ±è·¯å£'},
        {'lat': 24.183333, 'lon': 120.683333, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (åŒ—å±¯å€)å´‡å¾·è·¯èˆ‡æ¾ç«¹è·¯å£'},
        {'lat': 24.191667, 'lon': 120.650000, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (è¥¿å±¯å€)ä¸­æ¸…è¯çµ¡é“èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.100000, 'lon': 120.683333, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (å¤§é‡Œå€)ä»åŒ–è·¯èˆ‡è‡³å–„è·¯å£'},
        {'lat': 24.166667, 'lon': 120.616667, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)è‡ºç£å¤§é“èˆ‡ç­å ¤è¥¿è¡—å£'},
        {'lat': 24.166667, 'lon': 120.641667, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)æƒ ä¸­è·¯èˆ‡å¸‚æ”¿åŒ—ä¸ƒè·¯å£'},
        {'lat': 24.141667, 'lon': 120.675000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å€)æ°‘æ¬Šè·¯èˆ‡è‡ºç£å¤§é“å£'},
        {'lat': 24.208333, 'lon': 120.700000, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (æ½­å­å€)ä¸­å±±è·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.183333, 'lon': 120.650000, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (è¥¿å±¯å€)å‡±æ—‹è·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.108333, 'lon': 120.600000, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (çƒæ—¥å€)é«˜éµäº”è·¯èˆ‡é«˜éµæ±è·¯å£'},
        {'lat': 24.183333, 'lon': 120.658333, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (è¥¿å±¯å€)ç’°ä¸­è·¯èˆ‡ä¸­æ¸…è·¯å£'},
        {'lat': 24.166667, 'lon': 120.633333, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (è¥¿å±¯å€)é»æ˜è·¯èˆ‡è‡ºç£å¤§é“å£'},
        {'lat': 24.158333, 'lon': 120.675000, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (åŒ—å€)ä¸­æ¸…è·¯èˆ‡äº”æ¬Šè·¯å£'},
        {'lat': 24.183333, 'lon': 120.600000, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (è¥¿å±¯å€)æ±å¤§è·¯èˆ‡è¥¿å±¯è·¯å£'},
        {'lat': 24.175000, 'lon': 120.683333, 'count': 13, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:13), (åŒ—å±¯å€)æ–‡å¿ƒè·¯èˆ‡å´‡å¾·è·¯å£'},
        {'lat': 24.183333, 'lon': 120.650000, 'count': 10, 'color': 'red', 'risk': 'é«˜å±éšª (ä»¶æ•¸:10), (è¥¿å±¯å€)ç’°ä¸­è·¯èˆ‡ä¸­æ¸…è¯çµ¡é“å£'},
        {'lat': 24.141667, 'lon': 120.666667, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (è¥¿å€)äº”æ¬Šè·¯èˆ‡æ°‘æ¬Šè·¯å£'},
        {'lat': 24.183333, 'lon': 120.700000, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (åŒ—å±¯å€)ç’°ä¸­æ±è·¯èˆ‡æ¾ç«¹è·¯å£'},
        {'lat': 24.175000, 'lon': 120.691667, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (åŒ—å±¯å€)æ–‡å¿ƒè·¯èˆ‡åŒ—å±¯è·¯å£'},
        {'lat': 24.166667, 'lon': 120.633333, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)é»æ˜è·¯èˆ‡æœé¦¬äºŒè¡—å£'},
        {'lat': 24.166667, 'lon': 120.650000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)æ«»èŠ±è·¯èˆ‡æ–‡å¿ƒè·¯å£'},
        {'lat': 24.166667, 'lon': 120.633333, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)ç’°ä¸­è·¯èˆ‡æœé¦¬è·¯å£'},
        {'lat': 24.208333, 'lon': 120.700000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (æ½­å­å€)ç¦è²´è·¯èˆ‡ç’°ä¸­æ±è·¯å£'},
        {'lat': 24.158333, 'lon': 120.675000, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (åŒ—å€)ä¸­æ¸…è·¯èˆ‡æ¼¢å£è·¯å£'},
        {'lat': 24.175000, 'lon': 120.633333, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (è¥¿å±¯å€)ç’°ä¸­è·¯èˆ‡è¥¿å±¯è·¯å£'},
        {'lat': 24.133333, 'lon': 120.616667, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (å—å±¯å€)æ°¸æ˜¥å—è·¯èˆ‡å¿ å‹‡è·¯å£'},
        {'lat': 24.150000, 'lon': 120.691667, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (åŒ—å€)ç²¾æ­¦è·¯èˆ‡é›™åè·¯å£'},
        {'lat': 24.141667, 'lon': 120.691667, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (æ±å€)é€²åŒ–è·¯èˆ‡ç²¾æ­¦è·¯å£'},
        {'lat': 24.066667, 'lon': 120.691667, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (éœ§å³°å€)å³°å ¤è·¯èˆ‡éŒ¦å·è·¯å£'},
        {'lat': 24.158333, 'lon': 120.683333, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (åŒ—å€)å­¸å£«è·¯èˆ‡é€²åŒ–åŒ—è·¯å£'},
        {'lat': 24.183333, 'lon': 120.666667, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (åŒ—å±¯å€)ç¶“è²¿ä¸€è·¯èˆ‡ä¸­æ¸…è·¯å£'},
        {'lat': 24.183333, 'lon': 120.600000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)è‡ºç£å¤§é“èˆ‡ç¦æ—è·¯å£'},
        {'lat': 24.166667, 'lon': 120.633333, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (è¥¿å±¯å€)æœé¦¬è·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.125000, 'lon': 120.666667, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (å—å€)äº”æ¬Šå—è·¯èˆ‡å¿ æ˜å—è·¯å£'},
        {'lat': 24.166667, 'lon': 120.708333, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (åŒ—å±¯å€)å¤ªåŸè·¯èˆ‡æ—±æºªæ±è·¯å£'},
        {'lat': 24.175000, 'lon': 120.716667, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (åŒ—å±¯å€)è»åŠŸè·¯èˆ‡å¤ªåŸè·¯å£'},
        {'lat': 24.108333, 'lon': 120.700000, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (å¤§é‡Œå€)æ–°ä»è·¯èˆ‡ç’°ä¸­æ±è·¯å£'},
        {'lat': 24.133333, 'lon': 120.716667, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (å¤ªå¹³å€)ä¸­å±±è·¯èˆ‡ç’°ä¸­æ±è·¯å£'},
        {'lat': 24.175000, 'lon': 120.625000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)ç’°ä¸­è·¯èˆ‡ç¦ç§‘è·¯å£'},
        {'lat': 24.166667, 'lon': 120.675000, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (åŒ—å€)å¤ªåŸè·¯èˆ‡æ¢…å·æ±è·¯å£'},
        {'lat': 24.141667, 'lon': 120.666667, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (è¥¿å€)ä¸‰æ°‘è·¯èˆ‡äº”æ¬Šè·¯å£'},
        {'lat': 24.150000, 'lon': 120.658333, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (è¥¿å€)å…¬ç›Šè·¯èˆ‡ç¾æ‘è·¯å£'},
        {'lat': 24.158333, 'lon': 120.650000, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (è¥¿å±¯å€)è‡ºç£å¤§é“èˆ‡æ±èˆˆè·¯å£'},
        {'lat': 24.166667, 'lon': 120.650000, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (è¥¿å±¯å€)é’æµ·è·¯èˆ‡æ–‡å¿ƒè·¯å£'},
        {'lat': 24.166667, 'lon': 120.641667, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (è¥¿å±¯å€)æƒ ä¾†è·¯èˆ‡è‡ºç£å¤§é“å£'},
        {'lat': 24.169443, 'lon': 120.627778, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (è¥¿å±¯å€)å¸‚æ”¿è·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.175000, 'lon': 120.608333, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)è‡ºç£å¤§é“èˆ‡å·¥æ¥­å€ä¸€è·¯å£'},
        {'lat': 24.175000, 'lon': 120.625000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)è¥¿å±¯è·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.183333, 'lon': 120.600000, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (è¥¿å±¯å€)è‡ºç£å¤§é“èˆ‡ç¦æ—è·¯å£'},
        {'lat': 24.208333, 'lon': 120.700000, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (æ½­å­å€)ç¦è²´è·¯èˆ‡ç’°ä¸­æ±è·¯å£'},
        {'lat': 24.158333, 'lon': 120.675000, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (åŒ—å€)å­¸å£«è·¯èˆ‡äº”æ¬Šè·¯å£'},
        {'lat': 24.325000, 'lon': 120.641667, 'count': 5, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:5), (å¤–åŸ”å€)ä¸‰ç’°è·¯èˆ‡ç”²åè·¯å£'},
        {'lat': 24.166667, 'lon': 120.641667, 'count': 5, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:5), (è¥¿å±¯å€)æƒ ä¸­è·¯èˆ‡è‡ºç£å¤§é“å£'},
        {'lat': 24.183333, 'lon': 120.700000, 'count': 5, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:5), (åŒ—å±¯å€)ç’°ä¸­æ±è·¯èˆ‡æ¾ç«¹è·¯å£'},
        {'lat': 24.141667, 'lon': 120.691667, 'count': 5, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:5), (æ±å€)è‡ªç”±è·¯èˆ‡é€²å¾·è·¯å£'},
        {'lat': 24.108333, 'lon': 120.608333, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (çƒæ—¥å€)ç«™å€ä¸€è·¯èˆ‡é«˜éµäº”è·¯å£'},
        {'lat': 24.191667, 'lon': 120.675000, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (åŒ—å±¯å€)å´‡å¾·è·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.100000, 'lon': 120.683333, 'count': 5, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:5), (å¤§é‡Œå€)ä»æ„›è·¯èˆ‡æˆåŠŸäºŒè·¯å£'},
        {'lat': 24.175000, 'lon': 120.691667, 'count': 5, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:5), (åŒ—å±¯å€)æ˜Œå¹³è·¯èˆ‡ç’°ä¸­è·¯å£'},
        {'lat': 24.183333, 'lon': 120.683333, 'count': 5, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:5), (åŒ—å±¯å€)å´‡å¾·è·¯èˆ‡æ¾ç«¹è·¯å£'},
        {'lat': 24.166667, 'lon': 120.708333, 'count': 5, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:5), (åŒ—å±¯å€)å—äº¬æ±è·¯èˆ‡å¤ªåŸè·¯å£'},
        {'lat': 24.175000, 'lon': 120.683333, 'count': 9, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:9), (åŒ—å±¯å€)æ–‡å¿ƒè·¯èˆ‡å´‡å¾·è·¯å£'},
        {'lat': 24.108333, 'lon': 120.608333, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (çƒæ—¥å€)ä¸­å±±è·¯èˆ‡é«˜éµæ±è·¯å£'},
        {'lat': 24.150000, 'lon': 120.683333, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (åŒ—å€)å¤ªåŸè·¯èˆ‡å´‡å¾·è·¯å£'},
        {'lat': 24.116667, 'lon': 120.666667, 'count': 8, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:8), (å—å€)å¿ æ˜å—è·¯èˆ‡åœ‹å…‰è·¯å£'},
        {'lat': 24.166667, 'lon': 120.650000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)è‡ºç£å¤§é“èˆ‡æ–‡å¿ƒè·¯å£'},
        {'lat': 24.166667, 'lon': 120.625000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)è‡ºç£å¤§é“èˆ‡å®‰å’Œè·¯å£'},
        {'lat': 24.175000, 'lon': 120.625000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)ç’°ä¸­è·¯èˆ‡ç¦ç§‘è·¯å£'},
        {'lat': 24.191667, 'lon': 120.650000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (è¥¿å±¯å€)ç’°ä¸­è·¯èˆ‡ä¸­æ¸…è¯çµ¡é“å£'},
        {'lat': 24.166667, 'lon': 120.700000, 'count': 7, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:7), (åŒ—å±¯å€)ç’°ä¸­æ±è·¯èˆ‡å¤ªåŸè·¯å£'},
        {'lat': 24.150000, 'lon': 120.683333, 'count': 6, 'color': 'orange', 'risk': 'ä¸­é¢¨éšª (ä»¶æ•¸:6), (åŒ—å€)ä¸‰æ°‘è·¯èˆ‡éŒ¦æ–°è¡—å£'},
    ]
    
    # å»ºç«‹ DataFrame æ–¹ä¾¿å¾ŒçºŒè™•ç†
    df = pd.DataFrame(fallback_data)

    # --- é€™è£¡é–‹å§‹æ˜¯é—œéµçš„è‡ªå‹•è£œåº§æ¨™é‚è¼¯ ---
    # å¦‚æœè³‡æ–™è£¡æœ‰ lat = 0.0 çš„ï¼Œå°±ä»£è¡¨éœ€è¦ç”¨ API å»æŸ¥
    if (df['lat'] == 0.0).any():
        # é¡¯ç¤ºé€²åº¦æ¢è®“ä½¿ç”¨è€…çŸ¥é“ç¨‹å¼æ²’ç•¶æ‰
        progress_text = "æ­£åœ¨åŠªåŠ›å¹«æ‚¨æŸ¥è©¢è·¯å£åº§æ¨™ (ä½¿ç”¨ OpenStreetMap)..."
        my_bar = st.progress(0, text=progress_text)
        
        # è¨­å®š user_agent é¿å…è¢« API å°é–
        geolocator = Nominatim(user_agent="taichung_traffic_fixer_v4")
        
        # æ‰¾å‡ºæ‰€æœ‰ç¼ºåº§æ¨™çš„è³‡æ–™ç´¢å¼•
        missing_indices = df[df['lat'] == 0.0].index
        total_missing = len(missing_indices)
        
        for i, idx in enumerate(missing_indices):
            row = df.loc[idx]
            # å¾ risk æ¬„ä½è£¡æŠŠè·¯å£åç¨±æŠ“å‡ºä¾†ï¼Œä¾‹å¦‚: "é«˜å±éšª (ä»¶æ•¸:11), (å—å±¯å€)æ–‡å¿ƒè·¯èˆ‡å‘ä¸Šè·¯å£" -> "(å—å±¯å€)æ–‡å¿ƒè·¯èˆ‡å‘ä¸Šè·¯å£"
            try:
                addr_part = row['risk'].split(', ')[-1]
                # æ¸…ç†ä¸€ä¸‹åœ°å€ï¼ŒæŠŠæ‹¬è™Ÿæ‹¿æ‰æ¯”è¼ƒå¥½æŸ¥
                clean_addr = addr_part.replace('(', '').replace(')', '').replace('è‡ºä¸­å¸‚', '').replace('å°ä¸­å¸‚', '')
                
                # ç°¡å–®ç§»é™¤è¡Œæ”¿å€åï¼Œç›´æ¥æŸ¥è·¯å£é€šå¸¸æ¯”è¼ƒæº–
                for dist in ['ä¸­å€', 'æ±å€', 'å—å€', 'è¥¿å€', 'åŒ—å€', 'åŒ—å±¯å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'å¤ªå¹³å€', 'å¤§é‡Œå€', 'éœ§å³°å€', 'çƒæ—¥å€', 'è±åŸå€', 'æ²™é¹¿å€', 'æ½­å­å€', 'å¤§é›…å€']:
                    clean_addr = clean_addr.replace(dist, '')
                
                # åŠ ä¸Šç¸£å¸‚åç¨±å»æŸ¥
                query = f"å°ä¸­å¸‚ {clean_addr}"
                
                # å‘¼å« geopy æŸ¥è©¢
                loc = geolocator.geocode(query, timeout=2)
                if loc:
                    # æŸ¥åˆ°äº†ï¼è¶•å¿«å¡«é€²å»
                    df.at[idx, 'lat'] = loc.latitude
                    df.at[idx, 'lon'] = loc.longitude
            except:
                # æŸ¥ä¸åˆ°å°±ç®—äº†ï¼Œè·³é
                pass 
            
            # æ›´æ–°é€²åº¦æ¢
            my_bar.progress(int((i + 1) / total_missing * 100), text=f"æ­£åœ¨å®šä½: {clean_addr} ({i+1}/{total_missing})")
            
        my_bar.empty() # è·‘å®Œå°±æŠŠé€²åº¦æ¢è—èµ·ä¾†
        
        # æœ€å¾ŒæŠŠé‚„æ˜¯æŸ¥ä¸åˆ°åº§æ¨™çš„é»æ‹¿æ‰ï¼Œä¸ç„¶æœƒé¡¯ç¤ºåœ¨æµ·è£¡ (0,0)
        df = df[df['lat'] != 0.0]
        
    return df

@st.cache_data
def get_osrm_route(start, end):
    # ç”¨ OSRM çš„å…è²» API ç®—è·¯å¾‘
    url = f"http://router.project-osrm.org/route/v1/driving/{start[1]},{start[0]};{end[1]},{end[0]}"
    try:
        r = requests.get(url, params={'overview': 'full', 'geometries': 'polyline'}, timeout=5)
        if r.status_code == 200:
            res = r.json()
            if res['code'] == 'Ok':
                route = res['routes'][0]
                # polyline.decode æœƒæŠŠç·¨ç¢¼éçš„å­—ä¸²è®Šå›ç¶“ç·¯åº¦ list
                return polyline.decode(route['geometry']), route['distance'], route['duration']
    except: pass
    return [], 0, 0

@st.cache_data
def geocode_address(address):
    # é€™æ˜¯çµ¦ä½¿ç”¨è€…è¼¸å…¥èµ·çµ‚é»ç”¨çš„ï¼Œä¸€æ¨£æ˜¯ç”¨ Nominatim
    try:
        loc = Nominatim(user_agent="tw_traffic_v2").geocode(f"å°ä¸­å¸‚ {address}")
        if loc: return loc.latitude, loc.longitude
    except: pass
    return None

def meters_per_degree(lat):
    # è¨ˆç®—ç¶“ç·¯åº¦æ›ç®—æˆå…¬å°ºçš„æ¯”ä¾‹ï¼Œç°¡å–®ç®—ä¸€ä¸‹å°±å¥½
    return 111320.0, 40075000.0 * math.cos(math.radians(lat)) / 360.0

# ------------------------ UI (ä½¿ç”¨è€…ä»‹é¢) ------------------------
st.set_page_config(page_title="å°ä¸­å¸‚è»Šç¦ç†±é»å°èˆª", layout="wide")
st.title("ğŸš— å°ä¸­å¸‚äº¤é€šäº‹æ•…ç†±é»å°èˆª")

# State (ç‹€æ…‹è®Šæ•¸)
# é€™è£¡æ˜¯ç”¨ä¾†è¨˜ä½ä½¿ç”¨è€…çš„æœå°‹çµæœï¼Œæ‰ä¸æœƒæŒ‰å€‹æŒ‰éˆ•ç•«é¢å°±æ¸…ç©º
if 'app_state' not in st.session_state:
    st.session_state.app_state = {
        'has_result': False, 'nearby_df': None, 'start_coords': None, 'end_coords': None,
        'route_path': [], 'route_dist': 0, 'route_time': 0,
        'start_name': "", 'end_name': "", 'buffer': 300,
        'center': [24.1477, 120.6733], 'zoom': 13
    }

# è¼‰å…¥è³‡æ–™ (é€™è¡Œæœƒè§¸ç™¼ä¸Šé¢çš„ load_taichung_open_data)
df_accidents = load_taichung_open_data()

with st.sidebar:
    st.header("ğŸ—ºï¸ è·¯å¾‘è¦åŠƒ")
    start_input = st.text_input("è¼¸å…¥èµ·é»", "å°ä¸­ç«è»Šç«™")
    end_input = st.text_input("è¼¸å…¥çµ‚é»", "é€¢ç”²å¤§å­¸")
    buffer_input = st.slider("è·¯å¾‘ç·©è¡è·é›¢", 50, 1000, 300, 50)
    run_query = st.button("è¦åŠƒè·¯å¾‘", type="primary")
    
    st.divider()
    st.caption(f"ç›®å‰æœ‰æ•ˆè·¯å£è³‡æ–™æ•¸: {len(df_accidents)} ç­†")

# æŒ‰ä¸‹æŒ‰éˆ•å¾Œçš„é‚è¼¯
if run_query and start_input and end_input:
    with st.spinner('è¦åŠƒè·¯å¾‘ä¸­...'):
        s_coords = geocode_address(start_input)
        e_coords = geocode_address(end_input)
        
        if s_coords and e_coords:
            path, dist, dur = get_osrm_route(s_coords, e_coords)
            if path:
                # é€™è£¡æ˜¯ç”¨ shapely ä¾†ç®—å“ªäº›é»åœ¨è·¯å¾‘é™„è¿‘
                if SHAPELY_AVAILABLE:
                    line = LineString([(p[1], p[0]) for p in path])
                    def is_near(row):
                        deg = line.distance(Point(row['lon'], row['lat']))
                        lat_m, lon_m = meters_per_degree(row['lat'])
                        # ç®—å‡ºè·é›¢æœ‰æ²’æœ‰å°æ–¼ buffer_input
                        return (deg * math.hypot(lat_m, lon_m)) <= buffer_input
                    mask = df_accidents.apply(is_near, axis=1)
                else:
                    # æ²’è£ shapely å°±å…¨éƒ¨é¡¯ç¤ºï¼Œé¿å…ç•¶æ‰
                    mask = [True] * len(df_accidents)

                # æŠŠçµæœå­˜èµ·ä¾†
                st.session_state.app_state.update({
                    'has_result': True, 'nearby_df': df_accidents[mask].copy(),
                    'start_coords': s_coords, 'end_coords': e_coords,
                    'route_path': path, 'route_dist': dist, 'route_time': dur,
                    'start_name': start_input, 'end_name': end_input,
                    'buffer': buffer_input, 'center': s_coords
                })
            else: st.error("è·¯å¾‘è¦åŠƒå¤±æ•—")
        else: st.error("æ‰¾ä¸åˆ°èµ·çµ‚é»")

# ç•«åœ°åœ–çš„éƒ¨åˆ†
state = st.session_state.app_state
m = folium.Map(location=state['center'], zoom_start=state['zoom'])
# é¸å€‹ä¹¾æ·¨çš„åº•åœ–
folium.TileLayer('CartoDB positron', name='ç°¡æ½”åº•åœ–').add_to(m)

# æŠŠæ‰€æœ‰äº‹æ•…é»éƒ½ç•«å‡ºä¾†ï¼Œé è¨­æ‰“é–‹
all_group = folium.FeatureGroup(name='âš ï¸ æ‰€æœ‰äº‹æ•…è·¯å£ (é»æ“Šé–‹å•Ÿ)', show=False)
for _, row in df_accidents.iterrows():
    folium.CircleMarker(
        [row['lat'], row['lon']], radius=4, color=row['color'], 
        fill=True, fill_opacity=0.6, popup=row['risk']
    ).add_to(all_group)
all_group.add_to(m)

# å¦‚æœæœ‰æœå°‹çµæœï¼Œå°±ç•«å‡ºè·¯å¾‘è·Ÿé™„è¿‘çš„ç†±é»
if state['has_result']:
    folium.PolyLine(state['route_path'], color="blue", weight=5, opacity=0.7).add_to(m)
    folium.Marker(state['start_coords'], icon=folium.Icon(color='green', icon='play'), tooltip="èµ·é»").add_to(m)
    folium.Marker(state['end_coords'], icon=folium.Icon(color='red', icon='stop'), tooltip="çµ‚é»").add_to(m)
    
    res_group = folium.FeatureGroup(name='è·¯å¾‘æ²¿ç·šç†±é»', show=True)
    for _, row in state['nearby_df'].iterrows():
        folium.CircleMarker(
            [row['lat'], row['lon']], radius=7, color=row['color'],
            fill=True, fill_opacity=0.9, popup=row['risk']
        ).add_to(res_group)
    res_group.add_to(m)
    
    st.success(f"è¦åŠƒå®Œæˆï¼š{state['start_name']} â {state['end_name']}")
    st.info(f"è·¯å¾‘å‘¨é‚Šç™¼ç¾ {len(state['nearby_df'])} å€‹äº‹æ•…é»")

folium.LayerControl().add_to(m)
st_folium(m, width=1200, height=650, returned_objects=[])

# ä¸‹è¼‰æŒ‰éˆ•
st.divider()
if state['has_result'] and state['nearby_df'] is not None:
    st.subheader("ğŸ“¥ ä¸‹è¼‰åˆ†æå ±å‘Š")
    csv = state['nearby_df'].to_csv(index=False).encode('utf-8-sig')
    st.download_button("ä¸‹è¼‰æ²¿ç·šäº‹æ•…è³‡æ–™ CSV", csv, "route_accidents.csv", "text/csv", type="primary")
